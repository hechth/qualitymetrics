<tool id="quality_metrics" name="Quality Metrics" version="2015.03.18">
  <description>Provides quality metrics and visualization of the data matrix</description>
	
  <command interpreter="Rscript">
    qualityMetrics_wrapper.R
      dataMatrix_in "$dataMatrix_in"
      sampleMetadata_in "$sampleMetadata_in"
      variableMetadata_in "$variableMetadata_in"
      
      dataMatrix_out "$dataMatrix_out"
      sampleMetadata_out "$sampleMetadata_out"
      variableMetadata_out "$variableMetadata_out"
      figure "$figure"
      information "$information"
  </command>
  
  <inputs>
    <param name="dataMatrix_in" type="data" label="Data matrix file" help="" format="tabular" />
	<param name="sampleMetadata_in" type="data" label="Sample metadata file" help="" format="tabular" />
	<param name="variableMetadata_in" type="data" label="Variable metadata file" help="" format="tabular" />
  </inputs>
  
  <outputs>
    <data name="dataMatrix_out" label="${tool.name}_${dataMatrix_in.name}" format="tabular" ></data>
	<data name="sampleMetadata_out" label="${tool.name}_${sampleMetadata_in.name}" format="tabular" ></data>
	<data name="variableMetadata_out" label="${tool.name}_${variableMetadata_in.name}" format="tabular" ></data>
	<data name="figure" label="${tool.name}_figure.pdf" format="pdf"/>
	<data name="information" label="${tool.name}_information.txt" format="txt"/>
  </outputs>
  
  <help>
 
.. class:: infomark

**Authors** Etienne Thevenot, Marion Landi, and Melanie Petera (W4M Core Development Team)

---------------------------------------------------

.. class:: infomark

**Please cite**

Etienne A. Thevenot, Aurelie Roux, Ying Xu, Eric Ezan, and Christophe Junot (2014). Statistical approaches to study the physiological variability of the human urinary metabolome. 8th French Metabolomics and Fluxomics Conference. Lyon, France.

---------------------------------------------------

.. class:: infomark

**References**

| Mason R., Tracy N. and Young J. (1997). A practical approach for interpreting multivariate T2 control chart signals. Journal of Quality Technology, 29:396-406.
| Alonso A., Julia A., Beltran A., Vinaixa M., Diaz M., Ibanez L., Correig X. and Marsal S. (2011). AStream: an R package for annotating LC/MS metabolomic data. Bioinformatics, 27:1339-1340. http://dx.doi.org/10.1093/bioinformatics/btr138

---------------------------------------------------

========================
Quality Metrics
========================

-----------
Description
-----------

 | The **Quality Metrics** tool provides quality metrics of the samples and variables, and visualization of the data matrix
 | The arguments are the **dataMatrix**, **sampleMetadata** and **variableMetadata** file names
 | The **sampleMetadata** is returned as output with 3 additional columns containing the p-values for the Hotellings'T2 and Z-scores of intensity deciles and proportion of missing values
 | The **variableMetadata** is returned as output; in case a **sampleType** column is included in the input sampleMetadata file, additional columns will be added to indicate the variable quality metrics (eg mean, sd, CV on 'pool', 'sample' or 'blank', or correlation with pool dilutions, depending on the known type present in the 'sampleType' column)
 | The **dataMatrix** is returned unchanged (for conveniance in chaining with other tools within a workflow)
 | A **figure** is generated (pdf file) which illustrates some of the computed sample and variable metric values

 
 
-----------------
Workflow position
-----------------

| In the workflow example below, the **Check Format** module is first used to check that the formats of the 3 tables (dataMatrix, sampleMetadata, variableMetadata) are correct;
| Then the **Quality Metrics** tool allows quantification and visualization of the quality of the dataMatrix intensities;
| Finally the **Generic Filter** tool enables samples and variables with outlier values.
| The table can be then used for eg statistical analyses.
|

.. image:: qualityMetrics_workflowPositionImage.png
        :width: 600

-----------
Input files
-----------

+----------------------------+---------+
| Parameter : num + label    |  Format |
+============================+=========+
| 1 : Data matrix file       | tabular |
+----------------------------+---------+
| 2 : Sample metadata file   | tabular |
+----------------------------+---------+
| 3 : Variable metadata file | tabular |
+----------------------------+---------+

|
| The **dataMatrix** file is the variable x sample table of intensities 
| The **sampleMetadata** file contains the metadata of the samples; in particular, when the 'sampleType' column is available, with known types such as 'blank', 'sample', 'pool', 'poolN' (where N is a dilution factor of the pool), metrics will be computed (eg mean, sd, CV, correlation with the dilution factor, etc) for each variable	
| The **variableMetadata** file contains the metadata of the variables
|	
| **Note:** Required formats for the dataMatrix, sampleMetadata, and variableMetadata files are described in the **HowTo** entitled 'Format Data For Postprocessing' available on the main page of Workflow4Metabolomics.org
| The formats of the 3 tables can be checked with the **Check Format** module
|


------------
Output files
------------


dataMatrix.tabular
	| tsv output
	| Identical to the input dataMatrix file.
	|

sampleMetadata.tabular
	| tsv output
	| 3 additional columns have been added to the input sampleMetadata file and contain the **p-values** of
	|  1) the **Hotelling's T2** test in the first plane of PC components (Mason et al, 1997)
	|  2) the **Z-score** of **intensity deciles** (Alonso et al, 2011)
	|  3) the **Z-score** of the proportion of **missing values** (Alonso et al, 2011)
	| for each test, low p-values indicate samples with extreme behaviour
	|

variableMetadata.tabular
	| tsv output
	| When the type of samples is available (ie the **sampleType** column is included in the input sampleMetadata file), variable metrics are computed: **sample**, **pool**, and **blank** **mean**, **sd** and **CV** (if the corresponding types are present in the 'sampleType' column), as well as **'blank' mean / 'sample' mean**, and **'pool' CV / 'sample' CV ratio**
	| If pool dilutions have been used and are indicated in the 'sampleType' column as **poolN** where N is an integer indicating the dilution factor (eg **pool2** for a two-fold dilution of the pool; note that the non-diluted pool remains indicated as 'pool') the Pearson **correlation** (and corresponding p-value) between the intensity and the dilution factor is computed for each variable.
	|
	
figure.pdf
	| Figure summarizing the various values of the computed metrics and tests; includes several visualizations of the samples (eg, PCA scores) and intensities (eg, image of the data matrix)
	|
	
information.txt
	| Text file with informations regarding the metrics computed, eg those depending on the availability of the 'sampleMetadata' column, and specific types such as 'sample', 'pool', pool dilutions ('poolN'), or 'blank'
	|
	
---------------------------------------------------

---------------
Working example
---------------

Input files
===========

| **To generate the "dataMatrix", "sampleMetadata" and "variableMetadata" files:**
|   **1) copy/paste the values below in three distinct .txt files**
|   **2) use the "Get Data" / "Upload File" in the "Tools" (left) panel from the Galaxy page by choosing:**
|     **Convert spaces to tabs: 'Yes'**
| 

**dataMatrix file**::

	dataMatrix QC_4 sam_44 sam_18 sam_23 blk_3 sam_9 sam_22 QC_6 blk_4
	met_031 5601185.9 4446133.4 4144765.4 3085899.9 NA 6748534.9 5819543.8 3256720.3 NA
	met_032 4.07 4.08 4.11 4.1 NA 4.04 4.13 4.11 NA
	met_033 1448205184 1456986135 993364802.3 1162711600 5569143.2 1043559922 1465003454 1052094028 5247494.3
	met_034 4.11 4.21 4.18 4.1 4.09 4.1 4.14 4.11 4.08
	met_035 3777580.7 2296751 1890711.7 1767424.6 6567.5 1906253.5 3043253.9 2856958.5 7940.8
	met_036 4.12 4.21 4.26 4.1 4.11 4.22 4.27 4.12 4.2
	met_037 4982658.7 3751181.8 4219033.2 2425759.9 NA 11978184.4 4306459.5 3352187 NA
	met_038 4.45 4.38 4.4 4.4 NA 4.44 4.46 4.32 NA
	met_039 6658087.7 3231434.7 2932986.5 4098788.3 NA 3691132.6 6108614.4 4541941.9 NA
	met_040 4.49 4.56 4.48 4.5 NA 4.45 4.54 4.46 NA
	
**sampleMetadata file**::

	sampleMetadata injectionOrder batch sampleType
	QC_4 19 batch1 pool
	sam_44 20 batch1 sample
	sam_18 23 batch1 sample
	sam_23 27 batch1 sample
	blk_3 31 batch1 blank
	sam_9 34 batch1 sample
	sam_22 38 batch1 sample
	QC_6 42 batch1 pool
	blk_4 43 batch1 blank

**variableMetadata file**::

	variableMetadata number
	met_031 31
	met_032 32
	met_033 33
	met_034 34
	met_035 35
	met_036 36
	met_037 37
	met_038 38
	met_039 39
	met_040 40

Figure output
=============

| You should obtain with this very simplified dataset the following figure:
|

.. image:: qualityMetrics_workingExampleImage.png
        :width: 600



  </help>
</tool>